name: Build and Release

on:
   push:
      branches: [main]
   workflow_dispatch:

permissions:
   contents: write
   actions: read

jobs:
   version:
      name: Determine next version
      runs-on: ubuntu-latest
      outputs:
         next_tag: ${{ steps.bump.outputs.next_tag }}
         previous_tag: ${{ steps.bump.outputs.previous_tag }}
         changelog: ${{ steps.read_changelog.outputs.changelog }}
      steps:
         - name: Checkout (full history for tags)
           uses: actions/checkout@v4
           with:
              fetch-depth: 0

         - name: Fetch tags
           run: git fetch --tags --force

         - name: Find latest vX.Y.Z and bump
           id: bump
           shell: bash
           run: |
              # Get the latest tag in the format vX.Y.Z (supports multi-digit)
              LATEST=$(git tag -l 'v*.*.*' --sort=-v:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n1)

              if [[ -z "$LATEST" ]]; then
                LATEST="v0.0.0"
              fi

              # Extract version parts (supports multi-digit numbers)
              if [[ ! "$LATEST" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
                echo "Tag '$LATEST' does not match pattern vX.Y.Z."
                exit 1
              fi

              MAJOR="${BASH_REMATCH[1]}"
              MINOR="${BASH_REMATCH[2]}"
              PATCH="${BASH_REMATCH[3]}"

              # If version is 1.0.0 or higher, only increment PATCH
              if [[ "$MAJOR" -ge 1 && "$MINOR" -eq 0 ]]; then
                PATCH=$((PATCH+1))
                echo "Version is at 1.0.x - incrementing PATCH only"
              else
                # Pre-1.0.0: use carry-over rules (single digit limit)
                if (( PATCH < 9 )); then
                  PATCH=$((PATCH+1))
                else
                  PATCH=0
                  if (( MINOR < 9 )); then
                    MINOR=$((MINOR+1))
                  else
                    MINOR=0
                    MAJOR=$((MAJOR+1))
                  fi
                fi
              fi

              NEXT_TAG="v${MAJOR}.${MINOR}.${PATCH}"
              echo "next_tag=$NEXT_TAG" >> "$GITHUB_OUTPUT"
              echo "previous_tag=$LATEST" >> "$GITHUB_OUTPUT"
              echo "Latest: $LATEST -> Next: $NEXT_TAG"

         - name: Generate Changelog
           id: changelog
           uses: orhun/git-cliff-action@v4
           with:
              config: cliff.toml
              args: |
                 ${{ steps.bump.outputs.previous_tag == 'v0.0.0' && '--unreleased' || format('{0}..{1}', steps.bump.outputs.previous_tag, steps.bump.outputs.next_tag) }}
                 --tag ${{ steps.bump.outputs.next_tag }}
           env:
              OUTPUT: CHANGELOG.md

         - name: Read Changelog
           id: read_changelog
           shell: bash
           run: |
              CHANGELOG=$(cat CHANGELOG.md)

              # Save changelog to output (escape for GitHub Actions)
              echo "changelog<<EOF" >> "$GITHUB_OUTPUT"
              echo "$CHANGELOG" >> "$GITHUB_OUTPUT"
              echo "EOF" >> "$GITHUB_OUTPUT"

              echo "Generated changelog:"
              echo "$CHANGELOG"

   build:
      name: Build Windows exe
      needs: version
      runs-on: windows-latest

      # Set environment variables for the entire job
      env:
         PROGRAM_NAME: 'FC Online Automation Tool'
         SECRET_KEY: ${{ secrets.SECRET_KEY }}
         DEBUG: 'False' # Set to False for production builds
         INTERNAL_API_URL: ${{ secrets.INTERNAL_API_URL }}
         RELEASE_URL: ${{ secrets.RELEASE_URL }}
         DISCORD__ROLES__DEVELOPER: ${{ secrets.DISCORD__ROLES__DEVELOPER }}
         DISCORD__WEBHOOKS__DEVELOP__ID: ${{ secrets.DISCORD__WEBHOOKS__DEVELOP__ID }}
         DISCORD__WEBHOOKS__DEVELOP__TOKEN: ${{ secrets.DISCORD__WEBHOOKS__DEVELOP__TOKEN }}
         DISCORD__ROLES__FCO: ${{ secrets.DISCORD__ROLES__FCO }}
         DISCORD__WEBHOOKS__FCO_REWARD__ID: ${{ secrets.DISCORD__WEBHOOKS__FCO_REWARD__ID }}
         DISCORD__WEBHOOKS__FCO_REWARD__TOKEN: ${{ secrets.DISCORD__WEBHOOKS__FCO_REWARD__TOKEN }}
         # OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
         # OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
         # OPENAI_TEMPERATURE: ${{ secrets.OPENAI_TEMPERATURE }}
         # OPENAI_MAX_RETRIES: ${{ secrets.OPENAI_MAX_RETRIES }}
         # ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
         # ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
         # ANTHROPIC_TEMPERATURE: ${{ secrets.ANTHROPIC_TEMPERATURE }}
         # ANTHROPIC_MAX_RETRIES: ${{ secrets.ANTHROPIC_MAX_RETRIES }}

      steps:
         - name: Checkout code
           uses: actions/checkout@v4

         - name: Set up Python
           uses: actions/setup-python@v5
           with:
              python-version: '3.12'

         - name: Install uv
           uses: astral-sh/setup-uv@v4
           with:
              enable-cache: true

         - name: Install dependencies
           run: |
              uv sync
              uv add pyinstaller

         - name: Install Inno Setup
           run: choco install innosetup

         - name: Generate build_config.py with secrets
           shell: bash
           run: |
              cat > app/core/build_config.py << 'EOF'
              # Auto-generated during build - DO NOT EDIT
              # This file contains production configuration

              PROGRAM_NAME = "${{ env.PROGRAM_NAME }}"
              SECRET_KEY = "${{ secrets.SECRET_KEY }}"
              DEBUG = ${{ env.DEBUG }}
              INTERNAL_API_URL = "${{ env.INTERNAL_API_URL }}"
              RELEASE_URL = "${{ secrets.RELEASE_URL }}"

              # Discord configuration with nested structure
              DISCORD = {
                  "webhooks": {
                      "develop": {
                          "id": "${{ secrets.DISCORD__WEBHOOKS__DEVELOP__ID }}",
                          "token": "${{ secrets.DISCORD__WEBHOOKS__DEVELOP__TOKEN }}"
                      },
                      "fco_reward": {
                          "id": "${{ secrets.DISCORD__WEBHOOKS__FCO_REWARD__ID }}",
                          "token": "${{ secrets.DISCORD__WEBHOOKS__FCO_REWARD__TOKEN }}"
                      }
                  },
                  "roles": {
                      "developer": "${{ secrets.DISCORD__ROLES__DEVELOPER }}",
                      "fco": "${{ secrets.DISCORD__ROLES__FCO }}"
                  }
              }
              EOF

         - name: Build executable
           run: uv run pyinstaller --clean build_onedir.spec

         - name: Create metadata.json
           shell: bash
           run: |
              VERSION="${{ needs.version.outputs.next_tag }}"
              VERSION=${VERSION#v}
              echo "{\"version\": \"$VERSION\"}" > dist/FC_Online_Tool/metadata.json

         - name: Compile Installer
           run: |
              & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "/DAppVersion=${{ needs.version.outputs.next_tag }}" setup.iss

         - name: Rename installer with version
           run: |
              mv dist/FC_Online_Tool_Setup.exe dist/FC_Online_Tool_Setup-${{ needs.version.outputs.next_tag }}.exe

         - name: Upload artifact
           uses: actions/upload-artifact@v4
           with:
              # Name artifact with version so release job can fetch the correct one
              name: FC_Online_Tool-${{ needs.version.outputs.next_tag }}
              path: dist/FC_Online_Tool_Setup-${{ needs.version.outputs.next_tag }}.exe
              if-no-files-found: error
              retention-days: 7

   release:
      name: Create GitHub Release
      needs: [version, build]
      runs-on: ubuntu-latest

      steps:
         - name: Download artifact
           uses: actions/download-artifact@v4
           with:
              name: FC_Online_Tool-${{ needs.version.outputs.next_tag }}
              path: ./dist/

         - name: Create Release (auto-create tag if missing)
           uses: softprops/action-gh-release@v2
           with:
              tag_name: ${{ needs.version.outputs.next_tag }} # <- automatically creates tag if it does not exist
              name: 'FC Online Tool ${{ needs.version.outputs.next_tag }}'
              files: ./dist/FC_Online_Tool_Setup-${{ needs.version.outputs.next_tag }}.exe
              draft: false
              prerelease: false
              body: |
                 ## ðŸš€ FC Online Automation Tool ${{ needs.version.outputs.next_tag }}

                 ### ðŸ“¦ Download
                 - **FC_Online_Tool_Setup-${{ needs.version.outputs.next_tag }}.exe** â€” Windows Installer

                 ### ðŸ”§ Installation
                 1. Download the installer
                 2. Run the installer and follow the steps
                 3. Windows Defender may show a warning â€” click "More info" then "Run anyway"

                 ---

                 ${{ needs.version.outputs.changelog }}

                 ---

                 **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ needs.version.outputs.previous_tag }}...${{ needs.version.outputs.next_tag }} automatically built from source.
           env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
