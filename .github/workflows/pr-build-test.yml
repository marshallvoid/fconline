name: PR Build & Installer Test

on:
   pull_request:
      branches: [main]
   workflow_dispatch:

permissions:
   contents: read
   actions: read

jobs:
   build-and-verify:
      name: Build & Verify
      runs-on: windows-latest

      steps:
         - name: Checkout code
           uses: actions/checkout@v4

         - name: Set up Python
           uses: actions/setup-python@v5
           with:
              python-version: '3.12'

         - name: Install uv
           uses: astral-sh/setup-uv@v4
           with:
              enable-cache: true

         - name: Install dependencies
           run: |
              uv sync
              uv add pyinstaller

         - name: Install Inno Setup
           run: choco install innosetup

         - name: Build executable
           run: uv run pyinstaller --clean build.spec

         - name: Create dummy metadata.json
           shell: bash
           run: |
              echo "{\"version\": \"0.0.0-test\"}" > dist/FC_Online_Automation/metadata.json

         - name: Compile Installer
           run: |
              & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "/DAppVersion=0.0.0-test" setup.iss

         - name: Upload installer artifact
           uses: actions/upload-artifact@v4
           with:
              name: FC_Online_Automation-test-build-${{ github.event.pull_request.number }}
              path: dist/FC_Online_Automation_Setup.exe
              if-no-files-found: error
              retention-days: 3
